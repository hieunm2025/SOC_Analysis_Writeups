### Phân Tích Mã (Code Analysis)

**Kỹ Thuật Reverse Engineering & Phân Tích Mã**

**Reverse engineering** là quá trình đi sâu vào mã máy hoặc các tệp thực thi, giúp chúng ta giải mã chức năng, hành vi và cấu trúc của phần mềm. Khi không có mã nguồn, chúng ta sẽ phân tích mã máy thông qua việc giải mã các hướng dẫn hợp ngữ, một quá trình được gọi là **phân tích mã hợp ngữ**. Điều này rất hữu ích khi chúng ta cần tìm hiểu các tính năng bị ẩn hoặc khó phát hiện, ngay cả khi đã thực hiện phân tích tĩnh và động.

Để giải mã mã máy, chúng ta sử dụng hai công cụ mạnh mẽ: **Disassembler** (trình giải mã mã máy) và **Debugger** (trình gỡ lỗi).

* **Disassembler** là công cụ giúp phân tích mã máy mà không cần phải thực thi chương trình, điều này rất hữu ích vì nó giúp chúng ta hiểu cấu trúc và logic của mã mà không phải kích hoạt các tính năng có thể gây hại. Các công cụ phổ biến như **IDA**, **Cutter**, và **Ghidra** được sử dụng để thực hiện phân tích tĩnh này.

* **Debugger**, ngoài việc giải mã mã máy thành mã hợp ngữ, còn cho phép chúng ta thực thi mã trong môi trường kiểm soát, thực thi từng bước lệnh, bỏ qua các đoạn mã cụ thể, hoặc dừng tại những điểm quan trọng thông qua các điểm dừng (breakpoints). Các công cụ phổ biến như **x32dbg**, **x64dbg**, **IDA**, và **OllyDbg** hỗ trợ việc gỡ lỗi.

### Mô Tả Quá Trình Phân Tích Mã

Quá trình **biên dịch** mã nguồn (như C hoặc C++) thành **mã máy** là một quá trình một chiều do **compiler** (trình biên dịch) thực hiện. Mã máy là ngôn ngữ nhị phân mà máy tính trực tiếp xử lý, nhưng nó rất khó hiểu đối với con người. **Hợp ngữ** (assembly language) là cầu nối giữa mã máy và con người, giúp chúng ta giải mã câu chuyện của mã máy.

Một **disassembler** sẽ chuyển mã máy thành mã hợp ngữ, giúp chúng ta nhìn thấy một chuỗi các hướng dẫn có thể đọc được. Hiểu biết về hợp ngữ và các ký tự của nó là rất quan trọng trong việc phân tích mã độc.

### Công Cụ Phân Tích Mã

**Disassembler** và **Debugger** là hai công cụ chính trong phân tích mã. **Disassembler** sẽ chuyển đổi mã máy thành mã hợp ngữ để chúng ta có thể hiểu được cấu trúc và logic của mã mà không cần thực thi nó. **Debugger** giúp chúng ta thực thi chương trình trong môi trường kiểm soát, kiểm tra từng bước lệnh và xác định các lỗi tiềm ẩn.

### Phân Tích Shell.exe

Chúng ta tiếp tục phân tích mẫu mã độc **shell.exe** trong thư mục **C:\Samples\MalwareAnalysis**. Đến thời điểm này, chúng ta đã phát hiện rằng chương trình này có cơ chế phát hiện môi trường sandbox và có một cơ chế **sleep** (ngủ) - delay 5 giây trước khi thực hiện các thao tác chính.

### Nhập Mẫu Mã Độc Vào **Disassembler** - IDA

Để tiếp tục phân tích, chúng ta sẽ sử dụng **IDA** - một công cụ phân tích mã mạnh mẽ. Đầu tiên, mở **IDA** bằng cách nhấp đúp vào shortcut hoặc chạy **Run as administrator** để đảm bảo quyền truy cập đầy đủ.

Khi mở **IDA**, chọn **New** và chọn **shell.exe** trong thư mục **C:\Samples\MalwareAnalysis** để phân tích. Sau khi chọn tệp, IDA sẽ tự động xác định loại kiến trúc bộ xử lý và bắt đầu phân tích tệp. Sau khi phân tích xong, bạn sẽ thấy mã hợp ngữ của **shell.exe** được hiển thị trong cửa sổ chính của **IDA**.

### Xem Mã Hợp Ngữ và Di Chuyển Giữa Các Chức Năng

**IDA** cung cấp hai chế độ hiển thị chính: **Graph view** và **Text view**.

* **Graph view** hiển thị một sơ đồ đồ họa về các khối cơ bản của chương trình và cách chúng liên kết với nhau. Điều này giúp dễ dàng nhận diện các vòng lặp, điều kiện, và các điểm nhảy trong mã.

* **Text view** hiển thị mã hợp ngữ với các địa chỉ bộ nhớ tương ứng, giúp chúng ta xem xét chi tiết từng lệnh trong mã.

Các chức năng (function) được hiển thị dưới dạng các nút trong **Graph view**. Mỗi chức năng có tên, địa chỉ, và kích thước của nó.

### Xác Định Chức Năng Chính (Main Function)

Khi phân tích mã độc, chúng ta cần xác định **main function** (chức năng chính) - nơi chứa logic chính của chương trình. Trong IDA, chức năng này sẽ được tìm thấy thông qua việc tìm kiếm các lệnh gọi chức năng hoặc nhảy (jump) tới các chức năng khác. Khi chúng ta tìm thấy chức năng chính, chúng ta có thể hiểu được cách thức mà phần mềm độc hại hoạt động.

### Phân Tích Sandbox Detection

Trong mã nguồn của **shell.exe**, chúng ta phát hiện một cơ chế **sandbox detection** - chương trình kiểm tra xem nó đang chạy trong một môi trường ảo (sandbox) hay không. Điều này giúp mã độc tránh bị phát hiện khi chạy trong môi trường phân tích.

Mã độc này sử dụng các API của Windows như **RegOpenKeyExA** để truy vấn registry và kiểm tra xem phần mềm **VMware Tools** có được cài đặt trên hệ thống hay không, giúp phát hiện môi trường sandbox. Nếu phát hiện sandbox, mã độc sẽ không thực thi các hành động nguy hiểm.

### Phân Tích Quá Trình Tải Mã Độc

Mã độc này tiếp tục tải một tệp thực thi **svchost.exe** từ URL **[http://ms-windows-update.com/svchost.exe](http://ms-windows-update.com/svchost.exe)** vào thư mục tạm thời. Sau khi tải xong, nó sẽ ghi tệp vào registry để đảm bảo rằng chương trình sẽ tự động khởi động lại mỗi khi máy tính khởi động.

### Xác Định Các Chỉ Số Nhận Diện (IOC)

Trong suốt quá trình phân tích, chúng ta đã xác định được các **IOC** (Indicators of Compromise), bao gồm:

* **URL:** [http://ms-windows-update.com/svchost.exe](http://ms-windows-update.com/svchost.exe)
* **IP:** 45.33.32.156
* **Registry Key:** SOFTWARE\Microsoft\Windows\CurrentVersion\Run

Những thông tin này giúp nhận diện và phòng ngừa các mối đe dọa tương tự trong tương lai.

### Kết Luận

Phân tích mã độc như **shell.exe** là một quá trình phức tạp, yêu cầu sử dụng các công cụ như **IDA** để phân tích mã hợp ngữ và hiểu rõ các hành vi của phần mềm độc hại. Bằng cách sử dụng **disassembler** và **debugger**, chúng ta có thể tìm ra cách thức hoạt động của phần mềm độc hại, từ đó xây dựng các biện pháp đối phó hiệu quả.
