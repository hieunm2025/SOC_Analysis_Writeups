
#### 1. Phân Tích Mã Là Gì?
Phân tích mã giống như việc bạn mở một chiếc hộp đen để xem bên trong có gì. Với mã độc, bạn sẽ nhìn vào cách chương trình hoạt động: nó chạy lệnh gì, luồng chạy ra sao, và dữ liệu được xử lý thế nào. Mục tiêu là hiểu mã độc làm gì (ví dụ: đánh cắp thông tin hay tải thêm file xấu), và tìm ra các dấu hiệu nhận biết (gọi là IOCs, như địa chỉ IP hay tên file).

#### 2. Reverse Engineering – "Đảo Ngược" Để Hiểu Mã Độc
Reverse engineering là kỹ thuật "lật ngược" file thực thi (như .exe) để xem cách nó chạy, dù không có mã nguồn gốc. 
- File thực thi là chương trình đã được "nén" từ ngôn ngữ con người (như C++) thành ngôn ngữ máy (machine code), chỉ máy tính hiểu.
- Bạn sẽ thấy mã ở dạng assembly (mã hợp ngữ), giống như tiếng Anh cơ bản cho máy tính, với lệnh như "mov" (di chuyển dữ liệu), "call" (gọi hàm), "jmp" (nhảy đến vị trí khác).
- Tại sao cần? Để phát hiện mã độc ẩn náu, như kiểm tra môi trường giả lập (sandbox) hoặc tải file xấu.

Hai công cụ chính giúp bạn:
- **Disassembler** (như IDA, Ghidra, Cutter): Chuyển mã máy thành assembly để xem mà không chạy chương trình (gọi là phân tích tĩnh, an toàn vì không kích hoạt mã độc).
- **Debugger** (như x64dbg, OllyDbg, hoặc IDA): Vừa xem assembly, vừa chạy chương trình từng bước, dừng lại để kiểm tra (như đặt "điểm dừng" – breakpoints).

#### 3. Quá Trình Biên Dịch Và Đảo Ngược
- Mã nguồn (source code) được biên dịch thành mã máy để máy chạy nhanh.
- Mã máy khó đọc như tiếng "ngoài hành tinh", nên disassembler biến nó thành assembly dễ hiểu hơn.
- Ví dụ: Với file shell.exe, bạn mở trong IDA, công cụ sẽ tự động "dịch" và hiển thị assembly để bạn khám phá.

#### 4. Phân Tích File Shell.exe Trong IDA
File mẫu shell.exe nằm ở C:\Samples\MalwareAnalysis trên máy mục tiêu. Nó có trick phát hiện sandbox và ngủ 5 giây trước khi hành động.

Cách làm:
1. Mở IDA, chọn shell.exe.
2. IDA tự giải mã, hiển thị ở hai chế độ:
   - **Graph View**: Sơ đồ như flowchart, cho thấy các khối lệnh (basic blocks) và cách chúng nối nhau (dễ thấy luồng chạy).
   - **Text View**: Danh sách lệnh với địa chỉ bộ nhớ, mũi tên chỉ nhảy (mũi tên đặc: nhảy luôn, mũi tên đứt: nhảy nếu điều kiện đúng).
3. Nhấn Space để đổi giữa hai view.

#### 5. Tìm Hàm Chính (Main Function)
Khi mở, IDA thường hiện hàm "start" – đây là điểm khởi đầu, nhưng chỉ khởi tạo thôi, không chứa logic chính (như mã độc làm gì).
- Cách tìm hàm chính: Xem lệnh "call" trong start, nhấn Enter để nhảy vào hàm phụ.
- Trong shell.exe:
  - sub_401650: Khởi tạo, gọi GetTickCount... Không phải chính.
  - sub_401180: Kiểm tra StartupInfo. Vẫn không.
  - Tiếp tục đào sâu, tìm sub_403250 (mình đổi tên thành assumed_Main). Đây là hàm chính, vì nó kiểm tra registry để phát hiện VMware (môi trường ảo).

Mẹo: Dùng Function List (View > Open subviews > Functions) để xem tất cả hàm. Nhấn Esc để quay lại hàm trước.

#### 6. Phân Tích Chi Tiết Hàm Assumed_Main
Hàm này như "trái tim" của mã độc:
- Kiểm tra registry bằng RegOpenKeyExA: Mở khóa SOFTWARE\VMware, Inc.\VMware Tools. Nếu có, hiện "Sandbox Detected" (phát hiện môi trường giả).
- Nếu qua, tiếp tục:
  1. Kiểm tra mạng: Gọi getaddrinfo cho tên miền iu...com (dài ngoằng). Nếu thành công, lại "Sandbox Detected".
  2. Kết nối IP 45.33.32.156:31337. Thất bại thì "Sandbox Detected".
  3. Tải file svchost.exe từ http://ms-windows-update.com/svchost.exe, lưu vào TEMP.
  4. Duy trì (persistence): Thêm svchost.exe vào registry SOFTWARE\Microsoft\Windows\CurrentVersion\Run với tên WindowsUpdater (chạy tự động khi khởi động).
  5. Tiêm mã: Tạo notepad.exe, chèn shellcode bằng VirtualAllocEx, WriteProcessMemory, CreateRemoteThread. Thành công thì hiện "Connection sent to C2".

#### 7. Các Dấu Hiệu Nhận Biết (IOCs)
- Tên miền: iu...com
- IP/cổng: 45.33.32.156:31337
- URL: http://ms-windows-update.com/svchost.exe
- Registry: SOFTWARE\Microsoft\Windows\CurrentVersion\Run (tên WindowsUpdater)
- File: svchost.exe ở TEMP
- User-agent: Windows-Update/7.6.7600.256 HOSTNAME
- Có thể có Bitcoin wallet truyền vào svchost.exe (có lẽ là miner).

#### 8. Hướng Dẫn Phân Tích File Orange.exe
Tải additional_samples.zip từ module, giải nén (pass: infected), chuyển vào máy mục tiêu qua RDP (user: htb-student, pass: HTB_@cademy_stdnt!).
Mở orange.exe trong IDA, làm tương tự shell.exe.

Nhiệm vụ:
1. Tìm khóa registry sửa để duy trì (persistence). Thường là SOFTWARE\Microsoft\Windows\CurrentVersion\Run (kiểm tra lệnh RegSetValueExA).
2. Tìm hàm chứa tên file intrenat.exe (file mã độc thả xuống). Dùng Shift+F12 tìm strings, tìm "intrenat.exe", xem cross-reference để thấy hàm (dạng sub_4XXXX3).

#### 9. Mẹo Sử Dụng IDA Như Chuyên Gia
- Đổi view: Nhấn Space.
- Di chuyển: Enter vào hàm, Esc quay lại.
- Đổi tên hàm: Nhấn N trên tên hàm (giúp nhớ dễ hơn).
- Xem sơ đồ: View > Graphs > Function calls (thấy hàm nào gọi hàm nào).
- Tìm strings: Shift+F12, tìm chuỗi như "intrenat.exe" hoặc registry key.

#### 10. Trả Lời Câu Hỏi Về Orange.exe
Dựa trên phân tích tương tự:
- Câu 1: Khóa registry là SOFTWARE\Microsoft\Windows\CurrentVersion\Run (tìm lệnh registry trong hàm persistence).
- Câu 2: Hàm chứa intrenat.exe là sub_4013B3 (kiểm tra strings và cross-ref).
