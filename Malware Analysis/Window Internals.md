### **Tổng Quan về Nội Dung Windows Internals trong Phân Tích Malware**

#### 1. **Chế Độ Hoạt Động của Windows**

* **User Mode (Chế Độ Người Dùng)**: Đây là chế độ mà hầu hết các ứng dụng và tiến trình người dùng hoạt động. Trong chế độ này, các tiến trình có quyền truy cập hạn chế vào tài nguyên hệ thống và phải tương tác với hệ điều hành qua các **API**. Dù vậy, malware có thể lợi dụng các tài nguyên dễ tiếp cận như tệp tin, registry, kết nối mạng, và có thể cố gắng **nâng quyền** để có thêm quyền truy cập.

* **Kernel Mode (Chế Độ Kernel)**: Đây là chế độ có quyền truy cập không giới hạn vào tài nguyên hệ thống và phần cứng. Các thành phần quan trọng như hệ điều hành, trình điều khiển thiết bị (device drivers), và các dịch vụ hệ thống chạy ở chế độ này. Malware nếu xâm nhập vào chế độ này sẽ có khả năng **kiểm soát cao** và có thể thao túng các chức năng hệ thống, ẩn mình, hoặc tấn công các cơ chế bảo mật.

#### 2. **Kiến Trúc Windows**

* **Các Thành Phần trong User Mode**:

  * **System Support Processes**: Các tiến trình hỗ trợ hệ thống như `winlogon.exe`, `smss.exe`, `services.exe` thực hiện các nhiệm vụ quan trọng nhưng không phải là các dịch vụ của Windows.
  * **Service Processes**: Các tiến trình thực thi các dịch vụ hệ thống như Windows Update Service và Print Spooler, hoạt động nền để phục vụ các yêu cầu hệ thống.
  * **User Applications**: Các ứng dụng người dùng, bao gồm cả ứng dụng 32-bit và 64-bit, tương tác với hệ điều hành thông qua API. Khi các API này được gọi, chúng sẽ được chuyển qua **NTDLL.DLL**, và quá trình này sẽ kích hoạt chuyển từ User Mode sang Kernel Mode để thực hiện các lệnh hệ thống.
  * **Environment Subsystems**: Các thành phần này cung cấp môi trường thực thi cho các loại ứng dụng đặc thù như **Win32 Subsystem**, **POSIX**, và **OS/2**.

* **Các Thành Phần trong Kernel Mode**:

  * **Executive**: Bao gồm các thành phần quản lý I/O, bảo mật, tiến trình, và các tác vụ quan trọng khác trong hệ điều hành.
  * **Kernel**: Quản lý tài nguyên hệ thống như lập lịch luồng, đồng bộ hóa, và xử lý các ngắt hệ thống.
  * **Device Drivers**: Trình điều khiển thiết bị giúp hệ điều hành giao tiếp với phần cứng.
  * **Hardware Abstraction Layer (HAL)**: Lớp trừu tượng này cung cấp một cách tiếp cận độc lập phần cứng, cho phép phần mềm tương tác với phần cứng mà không cần quan tâm đến từng loại phần cứng.

#### 3. **Luồng Gọi API trong Windows**

* Các ứng dụng người dùng có thể gọi **Windows API** để tương tác với hệ thống. Ví dụ, hàm `ReadProcessMemory` có thể được gọi để đọc bộ nhớ của một tiến trình khác. Quá trình này bắt đầu từ **kernel32.dll**, qua **NTDLL.DLL**, và sau đó chuyển đến **Kernel Mode** để thực hiện các thao tác yêu cầu. Malware có thể lợi dụng các API này để thực hiện hành vi độc hại mà người dùng không nhận biết.

#### 4. **Portable Executable (PE)**

* **PE Format** là định dạng tệp dùng để đóng gói các chương trình thực thi và **DLL** trong hệ điều hành Windows. Malware có thể khai thác các phần trong PE, đặc biệt là các **section** như `.text`, `.data`, `.rsrc` (tài nguyên), và `.idata` (các hàm nhập từ DLL). Việc phân tích cấu trúc PE là rất quan trọng để hiểu được cách malware hoạt động và làm thế nào chúng có thể thao túng hệ thống hoặc xâm nhập vào các tiến trình khác.

#### 5. **Quản Lý Tiến Trình**

* **PID (Process Identifier)** và **VAS (Virtual Address Space)** là các yếu tố quan trọng trong việc quản lý tiến trình. Mỗi tiến trình có không gian bộ nhớ ảo riêng, giúp bảo vệ tiến trình này khỏi việc bị ảnh hưởng bởi các tiến trình khác. Malware có thể lợi dụng các cơ chế này để thao túng bộ nhớ của tiến trình khác, ví dụ như trong các cuộc tấn công **process injection**.

#### 6. **Dynamic-Link Library (DLL)**

* **Import Functions**: Các hàm nhập khẩu từ DLL cho phép chương trình truy cập các chức năng từ thư viện bên ngoài. Malware thường lợi dụng các hàm này để thực hiện các tác vụ như thao tác với tệp tin, mạng, hoặc registry.
* **Export Functions**: Các hàm xuất khẩu từ DLL cho phép các chương trình khác sử dụng. Malware có thể lợi dụng những hàm này để giao tiếp với các chương trình khác hoặc mở rộng khả năng tấn công.

#### **Ứng Dụng trong Phân Tích Malware**

Phân tích các **Windows API**, **Portable Executable (PE)**, và **DLL** giúp các chuyên gia bảo mật nhận diện được các hoạt động đáng ngờ hoặc không hợp pháp trong hệ thống. Malware có thể sử dụng các API như `ReadProcessMemory`, `WriteProcessMemory`, hoặc các hàm từ **kernel32.dll** và **NTDLL.DLL** để thao túng bộ nhớ của các tiến trình khác, hoặc lợi dụng các thư viện **DLL** để thực hiện các tấn công tinh vi như **process injection**.

### **Kết Luận**

Hiểu rõ về **Windows Internals** là bước quan trọng để phân tích malware hiệu quả. Malware có thể khai thác cả **User Mode** và **Kernel Mode** để thực hiện hành vi độc hại. Phân tích các thành phần hệ thống như **PE file structure**, **DLL imports/exports**, và **API calls** sẽ giúp phát hiện các dấu hiệu xâm nhập của malware và các kỹ thuật mà chúng sử dụng để ẩn mình hoặc thao túng hệ thống.
# Thực hành
 kiểm tra độ entropy của phần .text trong tệp potato.exe bằng pestudio
 ![alt text](image.png)

 tìm và nhập tên hàm xuất khẩu từ Kernel32.dll bắt đầu bằng "Attach" trong x64dbg
 vào tab Symbol
 ![alt text](image-1.png)